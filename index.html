<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <title>Trafford Data Lab: Choroplether</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
        <meta charset="UTF-8"/>
        <meta name="keywords" content="trafford, vega-lite, choropleth, choropleths, map"/>
        <meta name="description" content="Trafford Data Lab web application allowing the quick creation of choropleth map visualisations based on Vega-Lite."/>

        <link rel="stylesheet" href="https://www.trafforddatalab.io/css/labBase.css"/>
        <link rel="stylesheet" href="https://www.trafforddatalab.io/css/labWebsite.css"/>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto"/>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/alertify.min.css"/>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/themes/default.min.css"/>

        <style>
            fieldset
            {
                border-radius: 10px;
                border: 1px solid #ccc;
                box-shadow: 5px 5px 10px #f0f0f0;
                margin-bottom: 20px;
                font-size: 0.85em;
                padding-top: 0.75em;
            }

            legend
            {
                font-size: 14px;
                font-weight: bold;
                text-transform: uppercase;
                background-color: #fc6721;
                color: #fff;
                border-radius: 10px;
                padding: 0 8px;
            }

            legend:hover, .showContentMsg:hover
            {
                cursor: pointer;
            }

            fieldset ul
            {
                padding-left: 1em;  /* don't indent the list past the left margin of the other content */
            }

            fieldset textarea
            {
                width: 100%;
                height: 6em;
                min-height: 6em;
                resize: vertical;
            }

            label
            {
                padding-right: 10px;
                font-size: 0.9em;
                font-weight: bold;
            }

            legend .fa
            {
                margin-left: 0.5em; /* move the expand/minimise icon away from legend name in the fieldsets */
            }

            select
            {
                margin-top: 1em;
            }

            .showContentMsg
            {
                color: #757575;
            }

            .longInputBox
            {
                width: 50%;
            }

            .longInputBoxLabel
            {
                display: inline-block;
                width: 7em;
            }

            #toolsPanel
            {
                max-width: 400px;
                float: left;
                padding-bottom: 10px;
            }

            #headerTitle
            {
                display: inline-block;
                padding-top: 19px;
                font-size: 20px;
                color: #757575;
            }

            #vegaLiteViz
            {
                float: right;
            }

            #updateButton
            {
                cursor: pointer;
                margin-left: 10px;
            }

            /* This span also has the class labButton applied to it */
            #updateIconContainer
            {
                padding: 6px 6px 4px 6px;
                border-radius: 20px;
            }

            /* This span also has the fa fa-redo-alt classes applied to it */
            #updateIcon
            {
                font-size: 20px;
            }

            @media (max-width:1080px)
            {
                #layoutContainer
                {
                    width: 500px;
                    margin: auto;
                }

                #vegaLiteViz
                {
                    float: none;
                }

                #toolsPanel
                {
                    width: 500px;
                    max-width: 500px;
                }
            }


            /* Overridden styles from labBase.css */
            .labButton
            {
                font-size: 1em;
                margin: 0;
                padding: 0 10px;
            }

            /* Overridden styles from labWebsite.css */
            .traffordDataLabLogo
            {
                float: left;
                padding-bottom: 9px;
            }

            @media (max-width:620px)
            {
                .main
                {
                    margin-top: 70px;
                }
            }

            /* Alertify theme overridden styles */
            .alertify .ajs-header
            {
                color: #757575;
            }

            .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-ok, .alertify .ajs-footer .ajs-buttons .ajs-button.ajs-cancel
            {
                color: #fc6721;
            }

            .alertify button:focus, .alertify input:focus
            {
                outline: 2px solid rgba(252, 103, 33, 0.2);
            }

            /* Font-Awesome overridden styles */
            .fa-exclamation-triangle
            {
                font-size: 300px;
                color: #ccc;
                display: block;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <a href="https://www.trafforddatalab.io/index.html"><img src="https://www.trafforddatalab.io/assets/logo/trafforddatalab_logo.svg" alt="Trafford Data Lab" width="93" border="0" class="traffordDataLabLogo"/></a>
                <span id="headerTitle">Choroplether</span>
            </div>

            <div class="main">
                <p>Choroplether allows the quick creation of <a href="https://www.axismaps.com/guide/univariate/choropleth/" target="_blank">choropleth maps</a> in <a href="https://vega.github.io/vega-lite/" target="_blank">Vega-Lite</a> using your own data. A demonstration showing the <a href="https://www.ons.gov.uk/" target="_blank"><abbr title="Office for National Statistics">ONS</abbr></a> 2017 mid-year population estimates for Trafford's wards has been automatically generated. Please read the <a href="documentation.html">documentation</a> for more information on how to use the application.</p>

                <div id="layoutContainer">
                    <div id="toolsPanel">
                        <!-- File loading form elements (hidden via CSS) START -->
                        <input type="file" id="localFileData" class="hideContent" onChange="localFileLoader(this,'data')"/>
                        <input type="file" id="localFileGeography" class="hideContent" onChange="localFileLoader(this,'geography')"/>
                        <!-- File loading elements END -->

                        <fieldset>
                            <legend onclick="toggleContentSection('data')">Data<span id="dataToggle" class="fa fa-minus"></span></legend>
                            <div id="dataShowContent" class="showContentMsg hideContent" onclick="toggleContentSection('data')">Provide the data...</div>
                            <div id="dataForm">
                                Provide the data in <a href="data_example.csv" target="_blank"><abbr title="Comma Separated Values">CSV</abbr></a> or <a href="data_example.json" target="_blank"><abbr title="JavaScript Object Notation">JSON</abbr></a> format (use the links to view an example of each type of file) by:
                                <br />
                                <ul>
                                    <li><span class="labButton" onclick="document.getElementById('localFileData').click()">Choosing a file</span> from your device,</li>
                                    <li>Entering a <abbr title="Uniform Resource Locator">URL</abbr> of a file into the box or,</li>
                                    <li>Entering data directly into the box</li>
                                </ul>
                                <textarea id="data" onChange="checkData(this)"></textarea>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend onclick="toggleContentSection('geography')">Geography<span id="geographyToggle" class="fa fa-plus"></span></legend>
                            <div id="geographyShowContent" class="showContentMsg" onclick="toggleContentSection('geography')">Choose a geography...</div>
                            <div id="geographyForm" class="hideContent">
                                Choose a geography from the list or select &quot;<span style="font-style: italic;">other (custom)...</span>&quot; for further options.
                                <br />
                                <select id="geographyList" onchange="checkGeographyChoice(this.value)">
                                    <optgroup label="Electoral Ward">
                                        <option value="https://www.trafforddatalab.io/spatial_data/ward/2017/trafford_ward_generalised.geojson" selected="selected">Trafford wards</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/ward/2017/gm_ward_generalised.geojson">Greater Manchester wards</option>
                                    </optgroup>
                                    <optgroup label="Lower Layer Super Output Area (LSOA)">
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2011/trafford_lsoa_generalised.geojson">Trafford LSOAs</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2011/gm_lsoa_generalised.geojson">Greater Manchester LSOAs</option>
                                    </optgroup>
                                    <optgroup label="Middle Layer Super Output Area (MSOA)">
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2011/trafford_msoa_generalised.geojson">Trafford MSOAs</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2011/gm_msoa_generalised.geojson">Greater Manchester MSOAs</option>
                                    </optgroup>
                                    <optgroup label="Miscellaneous">
                                        <option value="https://www.trafforddatalab.io/spatial_data/council_defined/trafford_localities.geojson">Trafford localities</option>
                                    </optgroup>
                                    <option value="other">Other (custom)...</option>
                                </select>

                                <div id="geographyCustom" class="hideContent">
                                    <br />
                                    Provide a custom geography in <a href="https://geojson.org/" target="_blank"><abbr title="Geographic data structure in JavaScript Object Notation">GeoJSON</abbr></a> format by:
                                    <br />
                                    <ul>
                                        <li><span class="labButton" onclick="document.getElementById('localFileGeography').click()">Choosing a file</span> from your device,</li>
                                        <li>Entering a <abbr title="Uniform Resource Locator">URL</abbr> of a file into the box or,</li>
                                        <li>Entering data directly into the box</li>
                                    </ul>
                                    <textarea id="geography" onChange="checkGeography(this.value)"></textarea>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend onclick="toggleContentSection('design')">Design<span id="designToggle" class="fa fa-plus"></span></legend>
                            <div id="designShowContent" class="showContentMsg" onclick="toggleContentSection('design')">Customise the output...</div>
                            <div id="designForm" class="hideContent">
                                Customise the output of the visualisation.
                                <br /><br />
                                <label for="vizTitle" class="longInputBoxLabel">Chart title:</label><input type="text" id="vizTitle" name="vizTitle" class="longInputBox" placeholder="Optional: title for visualisation" onchange="updateTitle(this.value)"/>
                                <br />
                                <label for="vizLegendTitle" class="longInputBoxLabel">Legend title:</label><input type="text" id="vizLegendTitle" name="vizLegendTitle" class="longInputBox" placeholder="Optional: title for legend" onchange="updateLegendTitle(this.value)"/>
                                <br />
                                <label for="vizAttribution" class="longInputBoxLabel">Attribution:</label><input type="text" id="vizAttribution" name="vizAttribution" class="longInputBox" placeholder="Required for OS & ONS products" onchange="updateAttribution(this.value)"/>
                                <br /><br />
                                Choose a palette from the list or select &quot;<span style="font-style: italic;">other (custom)...</span>&quot; to enter a valid <a href="https://vega.github.io/vega/docs/schemes/#seq-single-hue" target="_blank">sequential scheme name</a>.
                                <br />
                                <select id="paletteList" onchange="updatePalette(this)">
                                    <optgroup label="Sequential Single-Hue">
                                        <option value="blues">blues</option>
                                        <option value="browns">browns</option>
                                        <option value="greens">greens</option>
                                        <option value="oranges" selected="selected">oranges</option>
                                        <option value="teals">teals</option>
                                        <option value="warmgreys">warmgreys</option>
                                    </optgroup>
                                    <optgroup label="Sequential Multi-Hue">
                                        <option value="bluepurple">bluepurple</option>
                                        <option value="goldgreen">goldgreen</option>
                                        <option value="inferno">inferno</option>
                                        <option value="viridis">viridis</option>
                                        <option value="yellowgreenblue">yellowgreenblue</option>
                                        <option value="yelloworangered">yelloworangered</option>
                                    </optgroup>
                                    <option value="other">Other (custom)...</option>
                                </select>

                                <div id="paletteCustom" class="hideContent">
                                    <br />
                                    <label for="palette" class="longInputBoxLabel">Palette name:</label><input type="text" id="palette" name="palette" class="longInputBox" placeholder="Required: palette scheme name" onchange="updatePalette(this)"/>
                                    <br />
                                </div>
                                <p>
                                    Select the type of scale<span id="intervalsMsg" class="hideContent"> and number of intervals</span> to use.
                                    <br />
                                    <label for="scaleList">Scale:</label>
                                    <select id="scaleList" onchange="updateScale(this.value)">
                                        <option value="linear" selected="selected">Linear</option>
                                        <option value="quantile">Quantile</option>
                                        <option value="quantize">Equal intervals</option>
                                    </select>
                                    <span id="intervalsContainer" class="hideContent">
                                        &nbsp;&nbsp;
                                        <label for="intervalsList">Intervals:</label>
                                        <select id="intervalsList" onchange="updateIntervals(this.value)">
                                            <option value="4" selected="selected">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                        </select>
                                    </span>
                                </p>
                            </div>
                        </fieldset>

                        <span id="updateButton" onclick="createVisualisation()" title="Update the visualisation">
                            <span id="updateIconContainer" class="labButton">
                                <span id="updateIcon" class="fas fa-redo-alt fa3x" aria-hidden="true" onclick="createVisualisation()"></span>
                            </span> UPDATE
                        </span>
                    </div>
                    <div id="vegaLiteViz"></div>
                </div>
                <br class="noFloat"/>
            </div>

            <div class="footer">
                <div class="leftFooter">
                    <div class="logoMedia">
                        <span class="hideContent">Visit us on </span>
                        <a class="linkMedia" href="https://twitter.com/traffordDataLab" target="_blank"><span class="fab fa-twitter-square"></span><span class="hideContent">Twitter</span></a>
                        <span class="hideContent">, </span>
                        <a class="linkMedia" href="https://github.com/traffordDataLab" target="_blank"><span class="fab fa-github"></span><span class="hideContent">Github</span></a>
                        <span class="hideContent"> and </span>
                        <a class="linkMedia" href="https://medium.com/@traffordDataLab" target="_blank"><span class="fab fa-medium"></span><span class="hideContent">Medium<br /></span></a>
                    </div>
                    <div class="license">Code <a class="footerLink" href="https://github.com/traffordDataLab/choroplether/blob/master/LICENSE" target="_blank">licensed</a> under MIT</div>
                </div>
                <div class="rightFooter">
                    <a href="https://www.trafford.gov.uk" target="_blank"><img class="logoTrafford" src="https://www.trafforddatalab.io/images/trafford_council_logo_black_on_white_100px.png" alt="Trafford Council" border="0"/></a>
                </div>
            </div>
        </div>

        <!-- Load script libraries for Vega-Lite -->
        <script src="https://cdn.jsdelivr.net/npm/vega@5.5.3"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.0.0-beta.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-embed@5.1.2"></script>
        <!-- Alertify - Nice feedback mechanism to the user for errors and issues -->
        <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/alertify.min.js"></script>
        <!-- Our external file loader -->
        <script src="https://www.trafforddatalab.io/assets/javascript/labAjax.js"></script>

        <script>
            /*
                ### Attributions and licences ###

                Created:        2019-09-04 by James Austin - Trafford Data Lab
                Purpose:        Allow users to create Vega-Lite choropleth visualisations easily
                Dependencies:   Vega-Lite - (C) University of Washington Interactive Data Lab https://vega.github.io/vega-lite/
                                Alertify.js - (C) Mohammad Younes http://alertifyjs.com
                                Fontawesome - (C) Fonticons, Inc. All rights reserved https://fontawesome.com
                                All other code by Trafford Data Lab

                Licence:        Vega-Lite: https://github.com/vega/vega-lite/blob/master/LICENSE
                                Alertify: https://opensource.org/licenses/gpl-3.0
                                Fontawesome: https://fontawesome.com/license
                                Trafford Data Lab:

            */

            // Test that we're not in IE11 or worse
            if (navigator.userAgent.indexOf('MSIE') !== -1 || navigator.appVersion.indexOf('Trident/') > -1) {
                // Insert a message into the UI interface container
                document.getElementById('layoutContainer').innerHTML = '<h2>Unfortunately you need a modern browser to create Vega-Lite visualisations. Please upgrade or use this app in another browser.</h2>';
            }
            else {
                // Reference commonly used objects
                var vizContainer = document.getElementById('vegaLiteViz');          // the DIV where the visualisation is created
                var updateIcon = document.getElementById('updateIcon');             // the span containing the font awesome icon for updating the visualisation

                // Insert the default attribution into the input box based on the current year
                document.getElementById('vizAttribution').value = 'Contains National Statistics & OS data © Crown copyright and database right ' + new Date().getFullYear();

                // The Vega-Lite specification framework that forms the visualisation. Some objects are dynamically updated based on the user input
                var vegaLiteSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v4.0.0-beta.1.json",
                    "description": "Choropleth map visualisation created by https://www.trafforddatalab.io/choroplether.",
                    "autosize": "fit",
                    "width": 500,
                    "height": 500,
                    "title": {
                        "text": "",
                        "font": "Roboto",
                        "color": "#757575",
                        "fontSize": 18
                    },
                    "layer": [
                        {
                            "data": {
                                "url": document.getElementById("geographyList").value,
                                "format": {
                                    "property": "features"
                                }
                            },
                            "transform": [
                                {
                                    "lookup": "properties.area_code",
                                    "from": {
                                        "key": "area_code",
                                        "fields": ["value"]
                                    }
                                }
                            ],
                            "mark": {
                                "type": "geoshape",
                                "stroke": "white",
                                "strokeWidth": 1
                            },
                            "projection": {
                                "type": "mercator"
                            },
                            "encoding": {
                                "color": {
                                    "field": "value",
                                    "scale": {
                                        "scheme": {
                                            "name": document.getElementById("paletteList").value,
                                            "count": 0
                                        },
                                        "type": document.getElementById("scaleList").value
                                    },
                                    "type": "quantitative",
                                    "legend": {
                                        "title": "",
                                        "titleFont": "Roboto",
                                        "titleColor": "#757575",
                                        "direction": "horizontal",
                                        "orient": "bottom",
                                        "padding": 9
                                    }
                                },
                                "tooltip": [
                                    {
                                        "field": "properties.area_name",
                                        "type": "nominal",
                                        "title": "Area"
                                    },
                                    {
                                        "field": "value",
                                        "type": "quantitative",
                                        "title": "Value"
                                    }
                                ]
                            }
                        },
                        {
                            "data": {
                                "values": [
                                    {
                                        "note": document.getElementById('vizAttribution').value
                                    }
                                ]
                            },
                            "mark": {
                                "type": "text",
                                "align": "left",
                                "baseline": "bottom",
                                "dx": -40,
                                "dy": 283,
                                "fontSize": 8,
                                "tooltip": null
                            },
                            "encoding": {
                                "text": {"field": "note", "type": "nominal"}
                            }
                        }
                    ],
                    "config": {
                        "view": {
                            "stroke": "transparent"
                        }
                    }
                }

                // List of all valid Vega sequential palettes which the user can enter into the 'other' palette input box
                var vegaLiteSequentialPalettes = {
                    // single-hue
                    'blues': true,
                    'tealblues': true,
                    'teals': true,
                    'greens': true,
                    'browns': true,
                    'oranges': true,
                    'reds': true,
                    'purples': true,
                    'warmgreys': true,
                    'greys': true,
                    // multi-hue
                    'viridis': true,
                    'magma': true,
                    'inferno': true,
                    'plasma': true,
                    'bluegreen': true,
                    'bluepurple': true,
                    'goldgreen': true,
                    'goldorange': true,
                    'goldred': true,
                    'greenblue': true,
                    'orangered': true,
                    'purplebluegreen': true,
                    'purpleblue': true,
                    'purplered': true,
                    'redpurple': true,
                    'yellowgreenblue': true,
                    'yellowgreen': true,
                    'yelloworangebrown': true,
                    'yelloworangered': true,
                    'darkblue': true,
                    'darkgold': true,
                    'darkgreen': true,
                    'darkmulti': true,
                    'darkred': true,
                    'lightgreyred': true,
                    'lightgreyteal': true,
                    'lightmulti': true,
                    'lightorange': true,
                    'lighttealblue': true
                }


                // ========= Console warn override to handle issues raised from the vegaEmbed catch clause =========
                console.warnDefault = console.warn;     // Cache the default action for warn

                function displayErrorMessage() {
                    vizContainer.innerHTML = '<p>It is not possible to create a visualisation at the moment.</p><p>Check the data and/or the geography you are using.</p><p><span class="fa fa-exclamation-triangle" aria-hidden="true"></span></p>';
                }

                // overridden warn
                console.warn = function (args) {
                    displayErrorMessage();
                    return console.warnDefault(args);
                }
                // =========


                // ========= UI operations =========
                // Performs CSS class add/remove etc. to show/hide content sections
                function toggleContentSection(name) {
                    var elementIcon = document.getElementById(name + 'Toggle');
                    var elementMessage = document.getElementById(name + 'ShowContent');
                    var elementForm = document.getElementById(name + 'Form');

                    // Font Awesome icon in the legend
                    elementIcon.classList.toggle('fa-minus');
                    elementIcon.classList.toggle('fa-plus');

                    elementMessage.classList.toggle('hideContent'); // message to show the full content
                    elementForm.classList.toggle('hideContent');    // the main content of the fieldset
                }

                // Convey to the user that something is loading by spinning the update button icon
                function updateButtonSpin() {
                    updateIcon.classList.remove('fa-redo-alt');
                    updateIcon.classList.add('fa-spinner');
                    updateIcon.classList.add('fa-spin');
                }

                // Reset the update button back to its normal state after an update has been performed
                function updateButtonReset() {
                    updateIcon.classList.remove('fa-spin');
                    updateIcon.classList.remove('fa-spinner');
                    updateIcon.classList.add('fa-redo-alt');
                }
                // =========


                // ========= File loading capabilities, either from the local device or remotely =========
                // Attempt to obtain a local file prior to processing
                function localFileLoader(src, dest) {
                    if (src.value !== '') {
                        try {
                            var reader = new FileReader();
                   	        reader.onload = function (e) {
                                destEl = document.getElementById(dest);
                                destEl.value = e.target.result;
                                (dest === 'data') ? checkData(destEl) : checkGeography(destEl);
                   	        };
                            reader.readAsText(src.files[0]);
                            src.value = '';  // reset the value of the file input box in case the user chooses the same file again - as this would not result in the onchange event firing
                        }
                        catch(e) {
                            // we can't use window.FileReader or something else went wrong so inform the user
                            alertify.alert('Sorry, unable to load local file...','Unfortunately it is not possible to load local files using this browser. Please choose one of the other methods available for loading data.');
                        }
                    }
                }

                // Attempt to obtain a remote file via URL
                function remoteFileLoader(url) {
                    labAjax(url, function (data) {
                        if (data === null || data === '') {
                            alertify.alert('Sorry, data couldn\'t be loaded...', 'Please check you entered the URL correctly. If so, it may be that the file no longer exists, the URL has changed or the server rejected the request.');
                            return false;
                        }

                        processGeoJson(data);
                    }, { type: 'txt' });    // Don't get labAjax to do the parsing - just return the content as-is and we parse it in the processGeoJson function
                }
                // =========


                // ========= Dynamic changes to the Vega-Lite specification based on user choices =========
                // Check the input provided for the data of the visualisation
                function checkData(el) {
                    // Only attempt parsing if there is content within the data box
                    if (el.value !== '' && el.value !== null) {
                        // Is the content a URL (must be https://) or pasted data?
                        if (el.value.substring(0, 8) === 'https://') {
                            vegaLiteSpec.layer[0].transform[0].from.data = {
                                "url": el.value
                            }
                        }
                        else {
                            // the data must be in the box directly, either pasted or loaded locally
                            // if JSON.parse is used on non-JSON data it will throw a syntax error, hence the try-catch block

                            var data = el.value;
                            var format;

                            try {
                                data = JSON.parse(data);    // attempt to parse as JSON
                                format = 'json';
                            }
                            catch(e) {
                                // assumption now is that the data is CSV
                                // the following regex lines deal with newline characters to ensure the data is presented correctly as a continous string within the Vega-Lite spec
                                data = data.replace(/\\n/g, '\n');  // replace actual string occurences of "\n" with newline characters
                                data = data.replace(/\n/g, '\n');   // replace any carriage returns with newline characters
                                format = 'csv';

                                el.value = data;    // update the input field with the cleaned output
                            }

                            // add the data to the Vega-Lite spec
                            vegaLiteSpec.layer[0].transform[0].from.data = {
                                "values": data,
                                "format": {
                                    "type": format
                                }
                            }
                        }
                    }
                    else {
                        vegaLiteSpec.layer[0].transform[0].from.data = {};   // the data box is empty so set the spec accordingly
                    }

                    createVisualisation();  // update the visualisation
                }

                // Handle the UI changes based on the selection in the geography list
                function checkGeographyChoice(val) {
                    var customGeogContainer = document.getElementById('geographyCustom');
                    var geogVal = val;

                    if (geogVal === 'other') {
                        customGeogContainer.classList.remove('hideContent');    // remove the 'hideContent' class from the custom geography div
                        geogVal = document.getElementById('geography').value    // NOTE: the onchange event of the 'geography' textbox also calls checkGeography()
                    }
                    else if (!customGeogContainer.classList.contains('hideContent')) {
                        customGeogContainer.classList.add('hideContent');       // add the 'hideContent' class to the custom geography div
                    }

                    checkGeography(geogVal);
                }

                // Check the input provided for the geography of the visualisation
                function checkGeography(val) {
                    var geogVal = val;

                    if (geogVal !== '' && geogVal !== null && geogVal !== 'other') {
                        // Set up the common objects of the geography
                        vegaLiteSpec.layer[0].data = {
                            "format": {
                                "property": "features"
                            }
                        }

                        // Is the content a URL (must be https://) or pasted data?
                        if (geogVal.substring(0, 8) === 'https://') {
                            vegaLiteSpec.layer[0].data.url = geogVal;    // create a URL object and set it to the value chosen in the geography select list
                            createVisualisation();              // update the visualisation
                        }
                        else {
                            // the data must be in the box directly, either pasted or loaded locally
                            // if JSON.parse is used on non-JSON data it will throw a syntax error, hence the try-catch block

                            try {
                                var data = JSON.parse(geogVal);     // as GeoJSON is valid JSON, attempt to parse it
                                vegaLiteSpec.layer[0].data.values = data;
                                createVisualisation();              // update the visualisation
                            }
                            catch(e) {
                                // Create an error message to inform the user that the GeoJSON isn't valid
                                alertify.alert('Sorry, geography isn\'t valid...', "The geography you are trying to use doesn't seem to be GeoJSON. Please check it and try again.");
                            }
                        }
                    }
                }

                // Check the input provided for the visualisation title
                function updateTitle(val) {
                    vegaLiteSpec.title.text = val;       // set the title based on the content provided by the user
                    adjustAttributionPosition();         // ensure the vertical position of the attribution is correct

                    createVisualisation();               // update the visualisation
                }

                // Check the input provided for the legend title
                function updateLegendTitle(val) {
                    vegaLiteSpec.layer[0].encoding.color.legend.title = val;    // set the legend title based on the content provided by the user
                    adjustAttributionPosition();                                // ensure the vertical position of the attribution is correct

                    createVisualisation();                                      // update the visualisation
                }

                // Check the input provided for the legend title
                function updateAttribution(val) {
                    vegaLiteSpec.layer[1].data.values[0].note = val;    // set the attribution based on the content provided by the user
                    adjustAttributionPosition();                        // ensure the vertical position of the attribution is correct

                    createVisualisation();                              // update the visualisation
                }

                // Make adjustments to the attribution's vertical offset depending on whether there are chart and/or legend titles
                function adjustAttributionPosition() {
                    if (vegaLiteSpec.title.text !== '' && vegaLiteSpec.layer[0].encoding.color.legend.title === '') {
                        vegaLiteSpec.layer[1].mark.dy = 273;
                    }
                    else if (vegaLiteSpec.title.text === '' && vegaLiteSpec.layer[0].encoding.color.legend.title !== '') {
                        vegaLiteSpec.layer[1].mark.dy = 293;
                    }
                    else {
                        vegaLiteSpec.layer[1].mark.dy = 283;
                    }
                }

                // Updates the palette scheme name used by the visualisation
                function updatePalette(el) {
                    var paletteName = el.value;
                    var paletteList = document.getElementById('paletteList');               // the palette select list
                    var paletteCustom = document.getElementById('paletteCustom');           // the container for the custom text box

                    if (paletteName === 'other') {
                        // we need to make sure that the "other" palette text box is visible
                        if (paletteCustom.classList.contains('hideContent')) paletteCustom.classList.remove('hideContent');

                        // load the value from the text box ready for further testing below - it could be blank or have a previous value entered by the user
                        paletteName = document.getElementById('palette').value;
                    }
                    else {
                        // we need to make sure that the "other" palette text box is hidden if the current select list value is not "other"
                        if (el === paletteList && !paletteCustom.classList.contains('hideContent')) paletteCustom.classList.add('hideContent');
                    }


                    if (paletteName !== '' && paletteName !== null && paletteName !== 'other') {
                        // Ensure that the value given is a valid sequential palette scheme.
                        // We do this by checking if there is a key with the same name in the object vegaLiteSequentialPalettes.
                        // If there is it will return true, otherwise null - saves looping through an array etc.
                        if (vegaLiteSequentialPalettes[paletteName.toLowerCase()]) {
                            vegaLiteSpec.layer[0].encoding.color.scale.scheme.name = paletteName;    // uses the value from the palette list or the custom text box if the palette list option is "other"
                            createVisualisation();                                          // update the visualisation
                        }
                        else {
                            alertify.alert('Sorry, palette scheme name isn\'t valid...', "The palette you have chosen isn't a valid sequential Vega scheme. Please check the list of valid schemes and try again.");
                        }
                    }
                }

                // Update the scale method, e.g. linear, quantile, quantize
                function updateScale(val) {
                    var intervalsContainer = document.getElementById('intervalsContainer');     // the span around the intervals list
                    var intervalsMsg = document.getElementById('intervalsMsg');                 // the span around the wording " and number of intervals"

                    // Handle whether the breaks select list should be visible or not
                    if (val === 'linear') {
                        // Intervals list should be hidden
                        if (!intervalsContainer.classList.contains('hideContent')) {
                            intervalsContainer.classList.add('hideContent');
                            intervalsMsg.classList.add('hideContent');
                        }
                        vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = 0;            // we don't want a number of breaks as the interval is linear
                    }
                    else {
                        // Intervals list should be visible
                        if (intervalsContainer.classList.contains('hideContent')) {
                            intervalsContainer.classList.remove('hideContent');
                            intervalsMsg.classList.remove('hideContent');
                        }
                        vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = parseInt(document.getElementById('intervalsList').value);
                    }

                    vegaLiteSpec.layer[0].encoding.color.scale.type = val;   // set the interval type in the spec
                    createVisualisation();
                }

                // Update the number of breaks to use
                function updateIntervals(val) {
                    vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = parseInt(val);
                    createVisualisation();
                }
                // =========


                // Embed the visualisation within the page
                function createVisualisation() {
                    updateButtonSpin();

                    vizContainer.innerHTML = '';    // clear any previous visualisation

                    vegaEmbed('#vegaLiteViz', vegaLiteSpec, {defaultStyle: true}).then(function(result) {
                        updateButtonReset();
                    }).catch(function (error) {
                        displayErrorMessage();
                        updateButtonReset();
                    });
                }

                // On page load, pre-complete the data textbox with the example file and produce an initial visualisation as a demonstration
                labAjax('data_example.csv', function (data) {
                    dataTextBox = document.getElementById('data');  // refer to the data textarea
                    dataTextBox.value = data;                       // put in the example
                    checkData(dataTextBox);                         // parse it as required by Vega-Lite
                }, { type: 'txt' });
            }
        </script>
    </body>
</html>
