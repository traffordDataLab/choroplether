<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <title>Trafford Data Lab: Choroplether</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
        <meta charset="UTF-8"/>
        <meta name="keywords" content="trafford, vega-lite, choropleth, choropleths, map"/>
        <meta name="description" content="Trafford Data Lab web application allowing the quick creation of choropleth map visualisations based on Vega-Lite."/>

        <link rel="stylesheet" href="css/base.css"/>
        <link rel="stylesheet" href="css/main.css"/>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto"/>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">

        <style>
            fieldset
            {
                border-radius: 10px;
                border: 1px solid #ccc;
                box-shadow: 5px 5px 10px #f0f0f0;
                margin-bottom: 20px;
                font-size: 0.85em;
                padding-top: 0.75em;
            }

            fieldset textarea
            {
                width: 100%;
                height: 6em;
                min-height: 6em;
                resize: vertical;
            }

            select
            {
                margin-top: 1em;
            }

            legend
            {
                background-color: #5d77a3;
                border-radius: 10px;
                padding: 0 8px;
            }

            legend button
            {
                background-color: transparent;
                color: #fff;
                border: 0;
                padding: 0;
                font-size: 14px;
                text-transform: uppercase;
            }

            legend:hover, legend button:hover
            {
                cursor: pointer;
            }

            legend .fa
            {
                margin-left: 0.5em; /* move the expand/minimise icon away from legend name in the fieldsets */
            }

            fieldset ul
            {
                padding-left: 1em;  /* don't indent the list past the left margin of the other content */
            }

            .showContentMsg
            {
                color: #707070;
            }

            .longInputBox
            {
                width: 50%;
            }

            .longInputBoxLabel
            {
                display: inline-block;
                width: 7em;
            }

            #toolsPanel
            {
                max-width: 400px;
                float: left;
                padding-bottom: 10px;
            }

            #vegaLiteViz
            {
                float: right;
            }

            #updateButton
            {
                margin-left: 10px;
                padding: 6px 12px 6px 6px;
                border-radius: 20px;
            }

            /* This span also has the fa fa-redo-alt classes applied to it */
            #updateIcon
            {
                font-size: 20px;
                margin-right: 4px;
            }

            @media (max-width:1160px)
            {
                #layoutContainer
                {
                    width: 500px;
                    margin: auto;
                }

                #vegaLiteViz
                {
                    float: none;
                }

                #toolsPanel
                {
                    width: 500px;
                    max-width: 500px;
                }
            }

            @media (max-width:620px)
            {
                #layoutContainer, #toolsPanel
                {
                    width: 100%;
                    max-width: 100%;
                }

                #vegaLiteViz
                {
                    width: 100%;
                    max-width: 100%;
                    overflow-x: scroll;
                }
            }

            /* Overridden styles from base.css */
            .labButton
            {
                font-size: 1em;
                margin: 0;
            }

            /* Font-Awesome overridden styles */
            .fa-exclamation-triangle
            {
                font-size: 300px;
                color: #ccc;
                display: block;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <nav>
                    <ul id="a11yNav">
                        <li><a href="#dataToggleButton" class="themeBlockDark">Skip to data section</a></li>
                    </ul>
                    <a href="https://www.trafforddatalab.io/index.html" aria-label="Go to the Trafford Data Lab home page"><img src="https://www.trafforddatalab.io/assets/logo/trafforddatalab_logo.svg" alt="Trafford Data Lab" width="93" border="0" class="traffordDataLabLogo"/></a>
                </nav>
                <h1 id="headerTitle">Choroplether</h1>
            </header>

            <main id="main">
                <p>Choroplether allows the quick creation of <a href="https://www.axismaps.com/guide/univariate/choropleth/" target="_blank">choropleth maps</a> in <a href="https://vega.github.io/vega-lite/" target="_blank">Vega-Lite</a> using your own data. A demonstration showing the <abbr title="Office for National Statistics"><a href="https://www.ons.gov.uk/" target="_blank" aria-label="ONS - Office for National Statistics">ONS</a></abbr> Census 2021 population estimates for local authorities in Greater Manchester has been automatically generated. <a href="documentation.html" target="_blank">The documentation</a> provides further details on using the app, however please note that Choroplether requires a modern browser - it will not work in Internet Explorer.</p>

                <div id="layoutContainer">
                    <div id="toolsPanel">
                        <fieldset>
                            <legend aria-label="data section, expanded"><button id="dataToggleButton" type="button" onclick="toggleContentSection('data')" aria-label="data section" aria-expanded="true">Data<span id="dataToggleIcon" class="fa fa-minus"></span></button></legend>
                            <div id="dataShowContent" class="showContentMsg hideContent" aria-label="Expand this section using the button to provide the data">Provide the data...</div>
                            <div id="dataForm">
                                <span id="dataInfo">Provide the data in <abbr title="Comma Separated Values"><a href="data_example.csv" target="_blank" aria-label="CSV - Comma Separated Values">CSV</a></abbr> or <abbr title="JavaScript Object Notation"><a href="data_example.json" target="_blank" aria-label="JSON - JavaScript Object Notation">JSON</a></abbr> format,</span> (use the links to download a template example of each file type):
                                <p>
                                    <button type="button" class="labButton" onclick="document.getElementById('localFileData').click()" aria-describedby="dataInfo">Choose a data file from your device</button> or
                                </p>
                                <label for="data" aria-describedby="dataInfo">Enter the data or its <abbr title="Uniform Resource Locator">URL</abbr> into the text box:</label><br />
                                <textarea id="data" onChange="checkData(this)" aria-label="data text box"></textarea>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend aria-label="geography section, collapsed"><button id="geographyToggleButton" type="button" onclick="toggleContentSection('geography')" aria-label="geography section" aria-expanded="false">Geography<span id="geographyToggleIcon" class="fa fa-plus"></span></button></legend>
                            <div id="geographyShowContent" class="showContentMsg" aria-label="Expand this section using the button to select a geography">Select a geography...</div>
                            <div id="geographyForm" class="hideContent">
                                <label for="geographyList">Select a geography</label> matching your data. Choose <span style="font-style: italic;">&quot;other (custom)&quot;</span> for further options:
                                <br />
                                <select id="geographyList" onchange="checkGeographyChoice(this.value)">
                                    <optgroup label="Local Authority">
                                        <option value="https://www.trafforddatalab.io/spatial_data/local_authority/2021/gm_local_authority_generalised.geojson" selected="selected">Greater Manchester Authorities (2021)</option>
                                    </optgroup>
                                    <optgroup label="Electoral Ward">
                                        <option value="https://www.trafforddatalab.io/spatial_data/ward/2023/trafford_ward_full_resolution.geojson">Trafford wards (2023)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/ward/2022/gm_ward_generalised.geojson">Greater Manchester wards (2022)</option>
                                    </optgroup>
                                    <optgroup label="Lower layer Super Output Area (LSOA)">
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2021/trafford_lsoa_generalised.geojson">Trafford LSOAs (2021)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2011/trafford_lsoa_generalised.geojson">Trafford LSOAs (2011)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2021/gm_lsoa_generalised.geojson">Greater Manchester LSOAs (2021)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/lsoa/2011/gm_lsoa_generalised.geojson">Greater Manchester LSOAs (2011)</option>
                                    </optgroup>
                                    <optgroup label="Middle layer Super Output Area (MSOA)">
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2021/trafford_msoa_generalised.geojson">Trafford MSOAs (2021)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2011/trafford_msoa_generalised.geojson">Trafford MSOAs (2011)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2021/gm_msoa_generalised.geojson">Greater Manchester MSOAs (2021)</option>
                                        <option value="https://www.trafforddatalab.io/spatial_data/msoa/2011/gm_msoa_generalised.geojson">Greater Manchester MSOAs (2011)</option>
                                    </optgroup>
                                    <optgroup label="Miscellaneous">
                                        <option value="https://www.trafforddatalab.io/spatial_data/council_defined/2023/trafford_localities_full_resolution.geojson">Trafford localities (2023)</option>
                                    </optgroup>
                                    <option value="other">Other (custom)</option>
                                </select>

                                <div id="geographyCustom" class="hideContent">
                                    <p id="geographyInfo">
                                        Provide the geography in <abbr title="Geospatial data in JavaScript Object Notation"><a href="https://geojson.org/" target="_blank" aria-label="GeoJSON - Geospatial data in JavaScript Object Notation">GeoJSON</a></abbr> format:
                                    </p>
                                    <p>
                                        <button type="button" id="geographyCustomFile" class="labButton" onclick="document.getElementById('localFileGeography').click()" aria-describedby="geographyInfo">Choose a geography file from your device</button> or
                                    </p>
                                    <label for="geography" aria-describedby="geographyInfo">Enter the geography or its <abbr title="Uniform Resource Locator">URL</abbr> into the text box:</label>
                                    <textarea id="geography" onChange="checkGeography(this.value)" aria-label="geography text box"></textarea>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend aria-label="design section, collapsed"><button id="designToggleButton" type="button" onclick="toggleContentSection('design')" aria-label="design section" aria-expanded="false">Design<span id="designToggleIcon" class="fa fa-plus"></span></button></legend>
                            <div id="designShowContent" class="showContentMsg" aria-label="Expand this section using the button to customise the map">Customise the map...</div>
                            <div id="designForm" class="hideContent">
                                Customise the map with titles, choose the palette etc.
                                <br /><br />
                                <label for="vizTitle" class="longInputBoxLabel">Map title:</label><input type="text" id="vizTitle" name="vizTitle" class="longInputBox" placeholder="Optional: title for map" onchange="updateTitle(this.value)"/>
                                <br />
                                <label for="vizLegendTitle" class="longInputBoxLabel">Legend title:</label><input type="text" id="vizLegendTitle" name="vizLegendTitle" class="longInputBox" placeholder="Optional: title for legend" onchange="updateLegendTitle(this.value)"/>
                                <br />
                                <label for="vizAttribution" class="longInputBoxLabel">Attribution:</label><input type="text" id="vizAttribution" name="vizAttribution" class="longInputBox" placeholder="Required for OS & ONS products" onchange="updateAttribution(this.value)"/>
                                <br /><br />
                                <label for="paletteList">Select a palette</label>. Choose <span style="font-style: italic;">&quot;other (custom)&quot;</span> for further options:
                                <br />
                                <select id="paletteList" onchange="updatePalette(this)">
                                    <optgroup label="Sequential Single-Hue">
                                        <option value="blues">blues</option>
                                        <option value="browns">browns</option>
                                        <option value="greens">greens</option>
                                        <option value="oranges">oranges</option>
                                        <option value="teals">teals</option>
                                        <option value="tealblues" selected="selected">tealblues</option>
                                        <option value="warmgreys">warmgreys</option>
                                    </optgroup>
                                    <optgroup label="Sequential Multi-Hue">
                                        <option value="bluepurple">bluepurple</option>
                                        <option value="goldgreen">goldgreen</option>
                                        <option value="inferno">inferno</option>
                                        <option value="viridis">viridis</option>
                                        <option value="yellowgreenblue">yellowgreenblue</option>
                                        <option value="yelloworangered">yelloworangered</option>
                                    </optgroup>
                                    <option value="other">Other (custom)</option>
                                </select>

                                <div id="paletteCustom" class="hideContent">
                                    <p id="paletteInfo">
                                        Enter a valid <a href="https://vega.github.io/vega/docs/schemes/#seq-single-hue" target="_blank">sequential palette scheme name</a>
                                    </p>
                                    <p>
                                        <label for="palette" class="longInputBoxLabel" aria-describedby="paletteInfo">Palette name:</label><input type="text" id="palette" name="palette" class="longInputBox" placeholder="Required: sequential scheme name" onchange="updatePalette(this)"/>
                                    </p>
                                </div>
                                <p>
                                    Select the type of scale<span id="intervalsMsg" class="hideContent"> and number of intervals</span> to use.
                                    <br />
                                    <label for="scaleList">Scale:</label>
                                    <select id="scaleList" onchange="updateScale(this.value)">
                                        <option value="linear" selected="selected">Linear</option>
                                        <option value="quantile">Quantile</option>
                                        <option value="quantize">Equal intervals</option>
                                    </select>
                                    <span id="intervalsContainer" class="hideContent">
                                        &nbsp;&nbsp;
                                        <label for="intervalsList">Intervals:</label>
                                        <select id="intervalsList" onchange="updateIntervals(this.value)">
                                            <option value="4" selected="selected">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                        </select>
                                    </span>
                                </p>
                            </div>
                        </fieldset>

                        <button id="updateButton" type="button" onclick="createVisualisation()" aria-label="Update the map" class="labButton">
                            <span id="updateIcon" class="fas fa-redo-alt fa3x" aria-hidden="true"></span>
                            UPDATE
                        </button>
                    </div>
                    <div id="vegaLiteViz" aria-live="assertive"></div>
                </div>
            </main>
        </div>

        <!-- File loading form elements (hidden via CSS) START -->
        <div class="hideContent">
            <label>Data: <input type="file" id="localFileData" onChange="localFileLoader(this,'data')"/></label>
            <label>Geography<input type="file" id="localFileGeography" onChange="localFileLoader(this,'geography')"/></label>
        </div>
        <!-- File loading elements END -->

        <!-- Load script libraries for Vega-Lite -->
        <script src="https://cdn.jsdelivr.net/npm/vega@5.5.3"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-lite@4.0.0-beta.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/vega-embed@5.1.2"></script>
        <!-- Our external file loader -->
        <script src="https://www.trafforddatalab.io/assets/javascript/labAjax.js"></script>

        <script>
            /*
                ### Attributions and licences ###

                Created:        2019-09-04 by James Austin - Trafford Data Lab
                Purpose:        Allow users to create Vega-Lite choropleth visualisations easily
                Dependencies:   Vega-Lite - (C) University of Washington Interactive Data Lab https://vega.github.io/vega-lite/
                                Fontawesome - (C) Fonticons, Inc. All rights reserved https://fontawesome.com
                                All other code by Trafford Data Lab

                Licence:        Vega-Lite: https://github.com/vega/vega-lite/blob/master/LICENSE
                                Fontawesome: https://fontawesome.com/license
                                Trafford Data Lab: https://github.com/traffordDataLab/choroplether/blob/master/LICENSE

            */

            // Test that we're not in IE11 or worse
            if (navigator.userAgent.indexOf('MSIE') !== -1 || navigator.appVersion.indexOf('Trident/') > -1) {
                // Insert a message into the UI interface container
                document.getElementById('layoutContainer').innerHTML = '<h2>Unfortunately you need a modern browser to create Vega-Lite visualisations. Please upgrade or use this app in another browser.</h2>';
            }
            else {
                // Reference commonly used objects
                var vizContainer = document.getElementById('vegaLiteViz');          // the DIV where the visualisation is created
                var updateIcon = document.getElementById('updateIcon');             // the span containing the font awesome icon for updating the visualisation

                // Insert the default attribution into the input box based on the current year
                document.getElementById('vizAttribution').value = 'Contains National Statistics & OS data © Crown copyright and database right ' + new Date().getFullYear();

                // The Vega-Lite specification framework that forms the visualisation. Some objects are dynamically updated based on the user input
                var vegaLiteSpec = {
                    "$schema": "https://vega.github.io/schema/vega-lite/v4.0.0-beta.1.json",
                    "description": "Choropleth map visualisation created by https://www.trafforddatalab.io/choroplether.",
                    "autosize": "fit",
                    "width": 500,
                    "height": 500,
                    "title": {
                        "text": "",
                        "font": "Roboto",
                        "color": "#757575",
                        "fontSize": 18
                    },
                    "layer": [
                        {
                            "data": {
                                "url": document.getElementById("geographyList").value,
                                "format": {
                                    "property": "features"
                                }
                            },
                            "transform": [
                                {
                                    "lookup": "properties.area_code",
                                    "from": {
                                        "key": "area_code",
                                        "fields": ["value"]
                                    }
                                }
                            ],
                            "mark": {
                                "type": "geoshape",
                                "stroke": "white",
                                "strokeWidth": 1
                            },
                            "projection": {
                                "type": "mercator"
                            },
                            "encoding": {
                                "color": {
                                    "field": "value",
                                    "scale": {
                                        "scheme": {
                                            "name": document.getElementById("paletteList").value,
                                            "count": 0
                                        },
                                        "type": document.getElementById("scaleList").value
                                    },
                                    "type": "quantitative",
                                    "legend": {
                                        "title": "",
                                        "titleFont": "Roboto",
                                        "titleColor": "#757575",
                                        "direction": "horizontal",
                                        "orient": "bottom",
                                        "padding": 9
                                    }
                                },
                                "tooltip": [
                                    {
                                        "field": "properties.area_name",
                                        "type": "nominal",
                                        "title": "Area"
                                    },
                                    {
                                        "field": "value",
                                        "type": "quantitative",
                                        "title": "Value"
                                    }
                                ]
                            }
                        },
                        {
                            "data": {
                                "values": [
                                    {
                                        "note": document.getElementById('vizAttribution').value
                                    }
                                ]
                            },
                            "mark": {
                                "type": "text",
                                "align": "left",
                                "baseline": "bottom",
                                "dx": -40,
                                "dy": 283,
                                "fontSize": 8,
                                "tooltip": null
                            },
                            "encoding": {
                                "text": {"field": "note", "type": "nominal"}
                            }
                        }
                    ],
                    "config": {
                        "view": {
                            "stroke": "transparent"
                        }
                    }
                }

                // List of all valid Vega sequential palettes which the user can enter into the 'other' palette input box
                var vegaLiteSequentialPalettes = {
                    // single-hue
                    'blues': true,
                    'tealblues': true,
                    'teals': true,
                    'greens': true,
                    'browns': true,
                    'oranges': true,
                    'reds': true,
                    'purples': true,
                    'warmgreys': true,
                    'greys': true,
                    // multi-hue
                    'viridis': true,
                    'magma': true,
                    'inferno': true,
                    'plasma': true,
                    'bluegreen': true,
                    'bluepurple': true,
                    'goldgreen': true,
                    'goldorange': true,
                    'goldred': true,
                    'greenblue': true,
                    'orangered': true,
                    'purplebluegreen': true,
                    'purpleblue': true,
                    'purplered': true,
                    'redpurple': true,
                    'yellowgreenblue': true,
                    'yellowgreen': true,
                    'yelloworangebrown': true,
                    'yelloworangered': true,
                    'darkblue': true,
                    'darkgold': true,
                    'darkgreen': true,
                    'darkmulti': true,
                    'darkred': true,
                    'lightgreyred': true,
                    'lightgreyteal': true,
                    'lightmulti': true,
                    'lightorange': true,
                    'lighttealblue': true
                }


                // ========= Console warn override to handle issues raised from the vegaEmbed catch clause =========
                console.warnDefault = console.warn;     // Cache the default action for warn

                function displayErrorMessage(msg) {
                    var errMsg = (msg === undefined) ? 'Check the data and/or the geography you are using.' : msg;

                    vizContainer.innerHTML = '<h2>Sorry, cannot create the map.</h2><p>' + errMsg + '</p><p><span class="fa fa-exclamation-triangle" aria-hidden="true"></span></p>';
                }

                // overridden warn
                console.warn = function (args) {
                    displayErrorMessage();
                    return console.warnDefault(args);
                }
                // =========


                // ========= UI operations =========
                // Performs CSS class add/remove etc. to show/hide content sections
                function toggleContentSection(name) {
                    var elIcon = document.getElementById(name + 'ToggleIcon');
                    var elMsg = document.getElementById(name + 'ShowContent');
                    var elForm = document.getElementById(name + 'Form');
                    var elButton = document.getElementById(name + 'ToggleButton');

                    // Font Awesome icon in the legend
                    elIcon.classList.toggle('fa-minus');
                    elIcon.classList.toggle('fa-plus');

                    elMsg.classList.toggle('hideContent');  // message to show the full content
                    elForm.classList.toggle('hideContent'); // the main content of the fieldset

                    // Accessibility features
                    if (elIcon.classList == 'fa fa-minus') {
                        // section is expanded
                        elButton.setAttribute('aria-expanded', 'true');
                        elButton.parentNode.setAttribute('aria-label', name + ' section, expanded');
                    }
                    else {
                        // section is collapsed
                        elButton.setAttribute('aria-expanded', 'false');
                        elButton.parentNode.setAttribute('aria-label', name + ' section, collapsed');
                    }
                }

                // Convey to the user that something is loading by spinning the update button icon
                function updateButtonSpin() {
                    updateIcon.classList.remove('fa-redo-alt');
                    updateIcon.classList.add('fa-spinner');
                    updateIcon.classList.add('fa-spin');
                }

                // Reset the update button back to its normal state after an update has been performed
                function updateButtonReset() {
                    updateIcon.classList.remove('fa-spin');
                    updateIcon.classList.remove('fa-spinner');
                    updateIcon.classList.add('fa-redo-alt');
                }
                // =========


                // ========= File loading capabilities, either from the local device or remotely =========
                // Attempt to obtain a local file prior to processing
                function localFileLoader(src, dest) {
                    if (src.value !== '') {
                        try {
                            var reader = new FileReader();
                   	        reader.onload = function (e) {
                                destEl = document.getElementById(dest);
                                destEl.value = e.target.result;
                                (dest === 'data') ? checkData(destEl) : checkGeography(destEl.value);
                   	        };
                            reader.readAsText(src.files[0]);
                            src.value = '';  // reset the value of the file input box in case the user chooses the same file again - as this would not result in the onchange event firing
                        }
                        catch(e) {
                            // we can't use window.FileReader or something else went wrong so inform the user
                            displayErrorMessage('Can\'t load local files using this browser.<br />Please provide the data using another method.');
                        }
                    }
                }
                // =========


                // ========= Dynamic changes to the Vega-Lite specification based on user choices =========
                // Check the input provided for the data of the visualisation
                function checkData(el) {
                    // Only attempt parsing if there is content within the data box
                    if (el.value !== '' && el.value !== null) {
                        // Is the content a URL (must be https://) or pasted data?
                        if (el.value.substring(0, 8) === 'https://') {
                            vegaLiteSpec.layer[0].transform[0].from.data = {
                                "url": el.value
                            }
                        }
                        else {
                            // the data must be in the box directly, either pasted or loaded locally
                            // if JSON.parse is used on non-JSON data it will throw a syntax error, hence the try-catch block

                            var data = el.value;
                            var format;

                            try {
                                data = JSON.parse(data);    // attempt to parse as JSON
                                format = 'json';
                            }
                            catch(e) {
                                // assumption now is that the data is CSV
                                // the following regex lines deal with newline characters to ensure the data is presented correctly as a continous string within the Vega-Lite spec
                                data = data.replace(/\\n/g, '\n');  // replace actual string occurences of "\n" with newline characters
                                data = data.replace(/\n/g, '\n');   // replace any carriage returns with newline characters
                                format = 'csv';

                                el.value = data;    // update the input field with the cleaned output
                            }

                            // add the data to the Vega-Lite spec
                            vegaLiteSpec.layer[0].transform[0].from.data = {
                                "values": data,
                                "format": {
                                    "type": format
                                }
                            }
                        }
                    }
                    else {
                        vegaLiteSpec.layer[0].transform[0].from.data = {};   // the data box is empty so set the spec accordingly
                    }

                    createVisualisation();  // update the visualisation
                }

                // Handle the UI changes based on the selection in the geography list
                function checkGeographyChoice(val) {
                    var customGeogContainer = document.getElementById('geographyCustom');
                    var geogVal = val;

                    if (geogVal === 'other') {
                        customGeogContainer.classList.remove('hideContent');    // remove the 'hideContent' class from the custom geography div
                        geogVal = document.getElementById('geography').value    // NOTE: the onchange event of the 'geography' textbox also calls checkGeography()
                        document.getElementById('geographyCustomFile').focus();
                    }
                    else if (!customGeogContainer.classList.contains('hideContent')) {
                        customGeogContainer.classList.add('hideContent');       // add the 'hideContent' class to the custom geography div
                    }

                    checkGeography(geogVal);
                }

                // Check the input provided for the geography of the visualisation
                function checkGeography(val) {
                    if (val !== '' && val !== null && val !== 'other') {
                        // Set up the common objects of the geography
                        vegaLiteSpec.layer[0].data = {
                            "format": {
                                "property": "features"
                            }
                        }

                        // These aspects relate to the keys used to bind to the data. The values apply to all geographies with the exception of Trafford Localities or custom geographies which use area_name (see below)
                        vegaLiteSpec.layer[0].transform[0].lookup = "properties.area_code";
                        vegaLiteSpec.layer[0].transform[0].from.key = "area_code";

                        // Is the content a URL (must be https://) or pasted data?
                        if (val.substring(0, 8) === 'https://') {
                            vegaLiteSpec.layer[0].data.url = val;    // create a URL object and set it to the value chosen in the geography select list

                            // Detect if the geography is Trafford's localities - if so we need to use area_name rather than area_code as the joining variable with the data.  As it is a custom created geography by Trafford Council it doesn't have ONS statistical area codes assigned to it.
                            if (val == 'https://www.trafforddatalab.io/spatial_data/council_defined/2023/trafford_localities_full_resolution.geojson' || val == 'https://www.trafforddatalab.io/council_open_data/boundaries/localities.geojson') {
                                vegaLiteSpec.layer[0].transform[0].lookup = "properties.area_name";
                                vegaLiteSpec.layer[0].transform[0].from.key = "area_name";
                            }

                            createVisualisation();                   // update the visualisation
                        }
                        else {
                            // The data must be in the box directly, either pasted or loaded locally
                            // If JSON.parse is used on non-JSON data it will throw a syntax error, hence the try-catch block
                            try {
                                var data = JSON.parse(val);     // as GeoJSON is valid JSON, attempt to parse it
                                vegaLiteSpec.layer[0].data.values = data;

                                // Check if the geography has a property called "area_code" - if not, we need to try to use "area_name" instead. If this doesn't exist then the app will report a general error and ask for the data and geography to be checked.
                                if (!data.features[0].properties.hasOwnProperty('area_code')) {
                                    vegaLiteSpec.layer[0].transform[0].lookup = "properties.area_name";
                                    vegaLiteSpec.layer[0].transform[0].from.key = "area_name";
                                }

                                createVisualisation();              // update the visualisation
                            }
                            catch(e) {
                                // Create an error message to inform the user that the GeoJSON isn't valid
                                displayErrorMessage('The geography isn\'t valid GeoJSON.<br />Please check it and try again.');
                            }
                        }
                    }
                }

                // Check the input provided for the visualisation title
                function updateTitle(val) {
                    vegaLiteSpec.title.text = val;       // set the title based on the content provided by the user
                    adjustAttributionPosition();         // ensure the vertical position of the attribution is correct

                    createVisualisation();               // update the visualisation
                }

                // Check the input provided for the legend title
                function updateLegendTitle(val) {
                    vegaLiteSpec.layer[0].encoding.color.legend.title = val;    // set the legend title based on the content provided by the user
                    adjustAttributionPosition();                                // ensure the vertical position of the attribution is correct

                    createVisualisation();                                      // update the visualisation
                }

                // Check the input provided for the legend title
                function updateAttribution(val) {
                    vegaLiteSpec.layer[1].data.values[0].note = val;    // set the attribution based on the content provided by the user
                    adjustAttributionPosition();                        // ensure the vertical position of the attribution is correct

                    createVisualisation();                              // update the visualisation
                }

                // Make adjustments to the attribution's vertical offset depending on whether there are chart and/or legend titles
                function adjustAttributionPosition() {
                    if (vegaLiteSpec.title.text !== '' && vegaLiteSpec.layer[0].encoding.color.legend.title === '') {
                        vegaLiteSpec.layer[1].mark.dy = 273;
                    }
                    else if (vegaLiteSpec.title.text === '' && vegaLiteSpec.layer[0].encoding.color.legend.title !== '') {
                        vegaLiteSpec.layer[1].mark.dy = 293;
                    }
                    else {
                        vegaLiteSpec.layer[1].mark.dy = 283;
                    }
                }

                // Updates the palette scheme name used by the visualisation
                function updatePalette(el) {
                    var paletteName = el.value;
                    var paletteList = document.getElementById('paletteList');               // the palette select list
                    var paletteCustom = document.getElementById('paletteCustom');           // the container for the custom text box

                    if (paletteName === 'other') {
                        var paletteCustomInput = document.getElementById('palette');

                        // we need to make sure that the "other" palette text box is visible
                        if (paletteCustom.classList.contains('hideContent')) paletteCustom.classList.remove('hideContent');

                        // load the value from the text box ready for further testing below - it could be blank or have a previous value entered by the user
                        paletteName = paletteCustomInput.value;

                        // set focus to the custom palette input box
                        paletteCustomInput.focus();
                    }
                    else {
                        // we need to make sure that the "other" palette text box is hidden if the current select list value is not "other"
                        if (el === paletteList && !paletteCustom.classList.contains('hideContent')) paletteCustom.classList.add('hideContent');
                    }


                    if (paletteName !== '' && paletteName !== null && paletteName !== 'other') {
                        // Ensure that the value given is a valid sequential palette scheme.
                        // We do this by checking if there is a key with the same name in the object vegaLiteSequentialPalettes.
                        // If there is it will return true, otherwise null - saves looping through an array etc.
                        if (vegaLiteSequentialPalettes[paletteName.toLowerCase()]) {
                            vegaLiteSpec.layer[0].encoding.color.scale.scheme.name = paletteName;   // uses the value from the palette list or the custom text box if the palette list option is "other"
                            createVisualisation();                                                  // update the visualisation
                        }
                        else {
                            displayErrorMessage('The palette isn\'t a valid sequential Vega scheme.<br />Please check the list of valid scheme names.');
                        }
                    }
                }

                // Update the scale method, e.g. linear, quantile, quantize
                function updateScale(val) {
                    var intervalsContainer = document.getElementById('intervalsContainer');     // the span around the intervals list
                    var intervalsMsg = document.getElementById('intervalsMsg');                 // the span around the wording " and number of intervals"

                    // Handle whether the breaks select list should be visible or not
                    if (val === 'linear') {
                        // Intervals list should be hidden
                        if (!intervalsContainer.classList.contains('hideContent')) {
                            intervalsContainer.classList.add('hideContent');
                            intervalsMsg.classList.add('hideContent');
                        }
                        vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = 0;            // we don't want a number of breaks as the interval is linear
                    }
                    else {
                        // Intervals list should be visible
                        if (intervalsContainer.classList.contains('hideContent')) {
                            intervalsContainer.classList.remove('hideContent');
                            intervalsMsg.classList.remove('hideContent');
                        }
                        vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = parseInt(document.getElementById('intervalsList').value);
                    }

                    vegaLiteSpec.layer[0].encoding.color.scale.type = val;   // set the interval type in the spec
                    createVisualisation();
                }

                // Update the number of breaks to use
                function updateIntervals(val) {
                    vegaLiteSpec.layer[0].encoding.color.scale.scheme.count = parseInt(val);
                    createVisualisation();
                }
                // =========


                // Embed the visualisation within the page
                function createVisualisation() {
                    updateButtonSpin();

                    vizContainer.innerHTML = '';    // clear any previous visualisation

                    try {
                        vegaEmbed('#vegaLiteViz', vegaLiteSpec, {defaultStyle: true}).then(function(result) {
                            updateButtonReset();
                        }).catch(function (error) {
                            displayErrorMessage();
                            updateButtonReset();
                        });
                    }
                    catch(e) {
                        // unexpected error
                        displayErrorMessage('An unexpected error occurred:<br />' + e.message);
                        updateButtonReset();
                    }

                    // add accessibility aria-label to the <detail>s action menu to explain its purpose
                    // has to be done in a setInterval in case the <details> element hasn't been created yet
                    var actionMenuA11yCb;

                    actionMenuA11yCb = setInterval(function () {
                        try {
                            var vegaActionMenu = document.getElementsByTagName('details')[0];
                            vegaActionMenu.setAttribute('aria-label', 'actions menu including options to download the map');

                            clearInterval(actionMenuA11yCb);
                        }
                        catch(e) {
                            // do nothing, the function will be called again in 100ms
                        }
                    }, 100);
                }

                // On page load, pre-complete the data textbox with the example file and produce an initial visualisation as a demonstration
                labAjax('data_example.csv', function (data) {
                    dataTextBox = document.getElementById('data');  // refer to the data textarea
                    dataTextBox.value = data;                       // put in the example
                    checkData(dataTextBox);                         // parse it as required by Vega-Lite
                }, { type: 'txt' });
            }
        </script>
    </body>
</html>
